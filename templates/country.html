{% extends "index.html" %}

{% block content %}
<!-- Country Hero Section -->
<section class="relative bg-cover bg-center bg-no-repeat py-20 md:py-28"
    style="background-image: url('{{ country.image }}');">
    <!-- Dark Overlay -->
    <div class="absolute inset-0 bg-black bg-opacity-60"></div>

    <!-- Content -->
    <div class="relative z-10 container mx-auto px-4 text-center">
        <div class="flex items-center justify-center mb-6">
            <a href="index.html" class="text-white hover:text-blue-300 mr-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <span class="text-gray-200">Home</span>
            <span class="mx-2 text-gray-400">/</span>
            <span class="text-white font-medium">{{ country.name }}</span>
        </div>
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4 drop-shadow-lg">
            Best eSIM Plans for {{ country.name }}
        </h1>

        <div class="flex items-center justify-center gap-2 mb-4">
            <img src="https://flagcdn.com/w40/{{ country.code|lower }}.png" alt="{{ country.name }} flag"
                class="w-10 h-7 object-cover rounded shadow-md" onerror="this.style.display='none'">
        </div>

        <p class="text-xl md:text-2xl text-gray-100 max-w-2xl mx-auto drop-shadow-md">
            Travel across {{ country.name }} with high-speed data.
        </p>
    </div>
</section>

<!-- Sticky Filter Bar -->
<nav class="sticky top-0 z-40 bg-white shadow-lg border-b-2 border-gray-300">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 py-3">
            <!-- Data Amount Filter (Buttons) -->
            <div id="data-filters" class="flex gap-2 overflow-x-auto scrollbar-hide w-full md:w-auto">
                <!-- Buttons will be injected here by JS -->
            </div>

            <!-- Duration Filter (Dropdown) -->
            <div class="relative w-auto min-w-[160px]" id="duration-container" style="display:none;">
                <label for="duration-filter" class="sr-only">Select Duration</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500">ðŸ“…</span>
                    </div>
                    <select id="duration-filter"
                        class="appearance-none block w-full pl-10 pr-8 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-lg shadow-sm bg-gray-50 text-gray-800 font-semibold cursor-pointer border hover:bg-white transition-colors duration-200">
                        <option value="all">Standard Duration</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main Plans Grid -->
<section class="container mx-auto px-4 py-8">

    <!-- Render Grouped Plans -->
    {% for group in grouped_plans %}
    <div class="plan-section mb-10" data-section-size="{{ group.filter_value }}">
        <div class="mb-4 text-center md:text-left">
            <h2 class="text-2xl font-bold text-gray-900">{{ group.title }}</h2>
            <p class="text-sm text-gray-500">Compare all providers for {{ group.title }}</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            {% for plan in group.plans %}
            <!-- Compact Blue Style Card -->
            <div class="provider-card group relative bg-white rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col h-full overflow-hidden"
                data-plans='{{ plan.json_data }}' data-provider="{{ plan.name }}"
                data-initial-days="{{ plan.duration }}" data-initial-price="{{ plan.price }}"
                data-initial-discount="{{ plan.discounted_price }}">

                <!-- OLD STYLE BADGE (Green Capsule Inside - Compact) -->
                <div
                    class="best-price-badge absolute top-3 right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-20 uppercase tracking-wide {% if not plan.is_cheapest %}hidden{% endif %}">
                    BEST PRICE
                </div>

                <div class="p-4 flex flex-col flex-grow relative"> <!-- Reduced Padding p-6 -> p-4 -->
                    <!-- Header -->
                    <div class="flex items-center gap-3 mb-2"> <!-- Reduced Margin mb-4 -> mb-2 -->
                        <div
                            class="w-10 h-10 rounded-lg bg-white p-1 border border-gray-100 flex items-center justify-center flex-shrink-0">
                            <!-- Smaller Logo w-12 -> w-10 -->
                            <img src="{{ plan.logo_url }}" alt="{{ plan.name }}" class="w-full h-full object-contain">
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900 text-base leading-tight">{{ plan.name }}</h3>
                            <!-- Smaller text-lg -> text-base -->
                            <div class="flex items-center gap-1">
                                <span class="text-yellow-400 text-xs">â˜…</span>
                                <span class="text-xs font-semibold text-gray-600">{{ "%.1f"|format(plan.rating)
                                    }}</span>
                                <span class="text-[10px] text-gray-400">({{ plan.review_count }})</span>
                            </div>
                        </div>
                    </div>

                    <!-- Price & Coupons Section (Side-by-Side) -->
                    <div class="flex items-center justify-between mb-3 min-h-[3.5rem] relative">
                        <!-- Flex Side-by-Side, fixed height -->
                        <!-- Price Node (Left) -->
                        <div class="flex flex-col justify-center flex-shrink-0 mr-1"> <!-- Reduced mr-2 -> mr-1 -->
                            {% if plan.discounted_price %}
                            <div class="flex items-baseline gap-1">
                                <span class="main-price text-3xl font-bold text-blue-600 leading-none">
                                    ${{ "%.2f"|format(plan.discounted_price) }}
                                </span>
                                <span class="old-price text-xs text-gray-400 line-through">
                                    ${{ "%.2f"|format(plan.price) }}
                                </span>
                            </div>
                            {% else %}
                            <span
                                class="main-price text-3xl font-bold leading-none {% if plan.is_cheapest %}text-green-600{% else %}text-blue-600{% endif %}">
                                ${{ "%.2f"|format(plan.price) }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Coupons Node (Right - Stacked) -->
                        {% if plan.coupons %}
                        <div class="flex flex-col items-end gap-1 flex-grow min-w-0 max-w-[70%] pr-0.5">
                            <!-- Increased max-w 55% -> 70% and added tiny pr -->
                            {% if plan.coupons.new_user %}
                            <div class="flex items-center justify-end gap-1 w-full">
                                <span
                                    class="text-[9px] font-bold text-green-700 bg-green-50 border border-green-200 px-1.5 py-0.5 rounded uppercase whitespace-nowrap flex-shrink-0">NEW</span>
                                <span class="text-[9px] font-mono text-gray-500 truncate block text-right"
                                    title="{{ plan.coupons.new_user.code }}">{{ plan.coupons.new_user.code }}</span>
                                <!-- Truncate + Title -->
                            </div>
                            {% endif %}
                            {% if plan.coupons.existing_user %}
                            <div class="flex items-center justify-end gap-1 w-full">
                                <span
                                    class="text-[9px] font-bold text-blue-700 bg-blue-50 border border-blue-200 px-1.5 py-0.5 rounded uppercase whitespace-nowrap flex-shrink-0">EXIST</span>
                                <span class="text-[9px] font-mono text-gray-500 truncate block text-right"
                                    title="{{ plan.coupons.existing_user.code }}">{{ plan.coupons.existing_user.code
                                    }}</span> <!-- Truncate + Title -->
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Features -->
                    <div class="space-y-1.5 mb-4 flex-grow border-t border-gray-100 pt-3">
                        <!-- Duration Removed -->
                        {% for benefit in plan.benefits[:4] %}
                        <div class="flex items-start gap-2 text-xs text-gray-500">
                            <span class="text-green-500 font-bold">âœ“</span>
                            <span class="line-clamp-1">{{ benefit }}</span>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- CTA Button -->
                    <div class="mt-auto">
                        <a href="{{ plan.link }}" target="_blank" rel="noopener noreferrer"
                            class="buy-btn group/btn relative w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md text-sm">
                            <!-- Compact Button -->
                            Get Plan
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <!-- Empty State -->
    <div id="no-plans-msg" class="hidden text-center py-20 bg-gray-50 rounded-lg">
        <h3 class="text-xl font-bold text-gray-700">No plans found for this filter.</h3>
        <p class="text-gray-500 mt-2">Try selecting a different option.</p>
    </div>

</section>

<!-- Combined Logic -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sections = document.querySelectorAll('.plan-section');
        const filterContainer = document.getElementById('data-filters');
        const durationContainer = document.getElementById('duration-container');
        const durationSelect = document.getElementById('duration-filter');
        const noPlansMsg = document.getElementById('no-plans-msg');

        // 1. Build Filter Buttons based on available Sections
        let availableSizes = [];
        sections.forEach(sec => {
            const size = parseFloat(sec.getAttribute('data-section-size'));
            if (!availableSizes.includes(size)) availableSizes.push(size);
        });
        availableSizes.sort((a, b) => a - b);

        // Create 'All' Button
        const allBtn = document.createElement('button');
        allBtn.className = 'filter-btn active px-6 py-2 text-sm font-bold text-white bg-blue-600 rounded-full transition-all duration-200 whitespace-nowrap shadow-md transform scale-105';
        allBtn.innerText = 'All';
        allBtn.onclick = () => showAll();
        filterContainer.appendChild(allBtn);

        // Create Size Buttons
        availableSizes.forEach(size => {
            const btn = document.createElement('button');
            const isUnlimited = size === 999;
            const label = isUnlimited ? 'Unlimited' : size + 'GB';

            btn.className = 'filter-btn px-5 py-2 text-sm font-semibold text-gray-600 bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300 rounded-full transition-all duration-200 whitespace-nowrap';
            btn.innerText = label;
            btn.onclick = () => filterBySize(size, btn);
            filterContainer.appendChild(btn);
        });

        // Initialize view
        showAll();

        // --- Functions ---

        function showAll() {
            updateButtons(allBtn);
            durationContainer.style.display = 'block';
            noPlansMsg.classList.add('hidden');
            sections.forEach(sec => sec.style.display = 'block');
            updateDurationOptions('all');
        }

        function filterBySize(size, clickedBtn) {
            updateButtons(clickedBtn);
            noPlansMsg.classList.add('hidden');

            let activeSection = null;
            sections.forEach(sec => {
                const secSize = parseFloat(sec.getAttribute('data-section-size'));
                if (secSize === size) {
                    sec.style.display = 'block';
                    activeSection = sec;
                } else {
                    sec.style.display = 'none';
                }
            });

            if (!activeSection) {
                noPlansMsg.classList.remove('hidden');
                durationContainer.style.display = 'none';
                return;
            }

            durationContainer.style.display = 'block';
            updateDurationOptions(size);
        }

        function updateDurationOptions(scopeSize) {
            let validDays = new Set();
            const targetSections = scopeSize === 'all'
                ? sections
                : document.querySelectorAll(`.plan-section[data-section-size="${scopeSize}"]`);

            targetSections.forEach(sec => {
                const secSize = parseFloat(sec.getAttribute('data-section-size'));
                const cards = sec.querySelectorAll('.provider-card');

                cards.forEach(card => {
                    try {
                        const plans = JSON.parse(card.getAttribute('data-plans') || '[]');
                        plans.forEach(p => {
                            let pSize = p.data === -1 ? 999 : p.data;
                            if (Math.abs(pSize - secSize) < 0.1) {
                                validDays.add(p.day);
                            }
                        });
                    } catch (e) { }
                });
            });

            const sortedDays = Array.from(validDays).sort((a, b) => a - b);
            const previousVal = durationSelect.value;
            durationSelect.innerHTML = '';

            if (sortedDays.length === 0) {
                durationContainer.style.display = 'none';
                return;
            }

            sortedDays.forEach(day => {
                const opt = document.createElement('option');
                opt.value = day;
                opt.innerText = day + ' Days';
                durationSelect.appendChild(opt);
            });

            let nextVal = sortedDays[0];
            if (previousVal !== 'all' && sortedDays.includes(parseInt(previousVal))) {
                nextVal = parseInt(previousVal);
            }

            durationSelect.value = nextVal;
            applyDurationFilter(scopeSize, nextVal);

            durationSelect.onchange = () => {
                const v = durationSelect.value;
                applyDurationFilter(scopeSize, parseInt(v));
            };
        }

        function applyDurationFilter(scopeSize, selectedDay) {
            const targetSections = scopeSize === 'all'
                ? sections
                : document.querySelectorAll(`.plan-section[data-section-size="${scopeSize}"]`);

            targetSections.forEach(sec => {
                const secSize = parseFloat(sec.getAttribute('data-section-size'));
                updateCardsInSection(sec, secSize, selectedDay);
            });
        }

        function updateCardsInSection(section, size, days) {
            const cards = section.querySelectorAll('.provider-card');

            // Console grouping for debugging
            // console.group(`UpdateCards: Section ${size}GB`);

            cards.forEach(card => {
                const plans = JSON.parse(card.getAttribute('data-plans') || '[]');
                const buyBtn = card.querySelector('a'); // Updated selector for new button
                const priceEl = card.querySelector('.main-price');
                const oldPriceEl = card.querySelector('.old-price'); // Might be missing if not initially rendered?
                const durationLabel = card.querySelector('.dynamic-duration-label');
                const bestBadge = card.querySelector('.best-price-badge');

                let match = null;

                if (days === 'all') {
                    const initialDays = parseInt(card.getAttribute('data-initial-days'));
                    const initialPrice = parseFloat(card.getAttribute('data-initial-price'));

                    // Priority 1: Match initial
                    match = plans.find(p => {
                        let pSize = p.data === -1 ? 999 : p.data;
                        return Math.abs(pSize - size) < 0.1 && p.day === initialDays;
                    });

                    // Priority 2: Cheapest
                    if (!match) {
                        const candidates = plans.filter(p => {
                            let pSize = p.data === -1 ? 999 : p.data;
                            return Math.abs(pSize - size) < 0.1;
                        });
                        if (candidates.length > 0) {
                            candidates.sort((a, b) => a.price - b.price);
                            match = candidates[0];
                        }
                    }
                } else {
                    match = plans.find(p => {
                        let pSize = p.data === -1 ? 999 : p.data;
                        return Math.abs(pSize - size) < 0.1 && p.day === days;
                    });
                }

                // Reset
                if (bestBadge) bestBadge.classList.add('hidden');
                card.classList.remove('border-green-500', 'ring-2', 'ring-green-500'); // Clean up old styles
                card.classList.add('border-gray-100'); // Restore default
                priceEl.classList.remove('text-green-600');
                priceEl.classList.add('text-blue-600'); // Restore Default Blue

                if (match) {
                    card.style.display = 'flex';
                    // Re-enable button
                    buyBtn.style.pointerEvents = 'auto';

                    let displayPrice = match.price;
                    let displayOldPrice = null;

                    // Discount Logic Check (Airalo/Using Data Attribute preferably, but recalculating here for safety)
                    const providerName = card.getAttribute('data-provider');
                    if (providerName.includes('Airalo')) {
                        displayOldPrice = displayPrice;
                        displayPrice = displayPrice * 0.85;
                    } else if (providerName.includes('Yesim')) {
                        displayOldPrice = displayPrice;
                        displayPrice = displayPrice * 0.80;
                    }

                    // Update Price Text
                    priceEl.innerText = '$' + displayPrice.toFixed(2);

                    // Update Old Price if it exists in DOM
                    if (oldPriceEl) {
                        if (displayOldPrice && displayOldPrice > displayPrice) {
                            oldPriceEl.innerText = '$' + displayOldPrice.toFixed(2);
                            oldPriceEl.classList.remove('hidden');
                        } else {
                            oldPriceEl.classList.add('hidden');
                        }
                    }

                    buyBtn.href = match.link;
                    if (durationLabel) durationLabel.innerText = `${match.day} Days Coverage`;

                } else {
                    card.style.display = 'none';
                }
            });

            // --- Cheapeast Logic (Robust) ---
            let minPrice = Infinity;

            // 1. Find Min
            cards.forEach(card => {
                if (card.style.display !== 'none') {
                    // Robust Parse with Regex
                    const pText = card.querySelector('.main-price').innerText;
                    const price = parseFloat(pText.replace(/[^0-9.]/g, ''));

                    if (!isNaN(price) && price > 0) {
                        if (price < minPrice) minPrice = price;
                    }
                }
            });

            // console.log(`Min Price Found: ${minPrice}`);

            // 2. Apply Badge
            cards.forEach(card => {
                if (card.style.display !== 'none') {
                    const pText = card.querySelector('.main-price').innerText;
                    const price = parseFloat(pText.replace(/[^0-9.]/g, ''));

                    // console.log(`Card ${card.getAttribute('data-provider')} Price: ${price}`);

                    if (Math.abs(price - minPrice) < 0.01) {
                        // Winner
                        const b = card.querySelector('.best-price-badge');
                        if (b) b.classList.remove('hidden');

                        // Visual Highlight - Green Border
                        card.classList.remove('border-gray-100');
                        card.classList.add('border-green-500', 'ring-1', 'ring-green-500'); // Green Active Border

                        // Green Text
                        const pEl = card.querySelector('.main-price');
                        pEl.classList.remove('text-blue-600', 'text-gray-900');
                        pEl.classList.add('text-green-600');
                    }
                }
            });

            // console.groupEnd();
        }

        function updateButtons(activeBtn) {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                b.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
            });
            activeBtn.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
        }
    });
</script>

<style>
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
</style>
{% endblock %}